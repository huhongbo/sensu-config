#!/usr/bin/env ruby
#
# System Cpu others
# ===
# code dn365

require 'rubygems' if RUBY_VERSION < '1.9.0'
require 'sensu-plugin/metric/cli'
require 'socket'
require 'sigar'

class SystemCpu < Sensu::Plugin::Metric::CLI::Graphite

  option :scheme,
    :description => "Metric naming scheme, text to prepend to .$parent.$child",
    :long => "--scheme SCHEME",
    :default => "#{Socket.gethostname}.cpu"

  def sprintf_int(num)
    sprintf("%.0f", num)
  end

  def run
    dname = "system"
    sigar = Sigar.new
    cpu = sigar.cpu
    cpu_irq, cpu_soft_irq, cpu_stolen, cpu_total = cpu.irq, cpu.soft_irq, cpu.stolen, cpu.total
    sleep 1
    
    cpu_total = sigar.cpu.total - cpu_total
    cpu_irq = (sigar.cpu.irq - cpu_irq).to_f / cpu_total
    cpu_soft_irq = (sigar.cpu.soft_irq - cpu_soft_irq).to_f / cpu_total
    cpu_stolen = (sigar.cpu.stolen - cpu_stolen).to_f / cpu_total
    timestamp = Time.now.to_i
    metrics = {
      :cpu => {
        :irq => sprintf_int(cpu_irq),
        :soft_irq => sprintf_int(cpu_soft_irq),
        :stolen => sprintf_int(cpu_stolen)
      }
    }
    metrics.each do |parent, children|
      children.each do |child, value|
        output [config[:scheme], dname, parent, child].join("."), value, timestamp
      end
    end
    ok
  end
end

