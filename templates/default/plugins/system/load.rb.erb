#!/usr/bin/env ruby
#
# System load Plugin
# ===
# code dn365

require 'rubygems' if RUBY_VERSION < '1.9.0'
require 'sensu-plugin/metric/cli'
require 'socket'
require 'sigar'

class Load < Sensu::Plugin::Metric::CLI::Graphite

  option :scheme,
    :description => "Metric naming scheme, text to prepend to .$parent.$child",
    :long => "--scheme SCHEME",
    :default => "#{Socket.gethostname}.load"

  def run
    dname = "system"
    loadavg = Sigar.new.loadavg
    timestamp = Time.now.to_i
    metrics = {
      :load => {
        :onemonute => loadavg[0],
        :fivemonute => loadavg[1],
        :fifteenmonute => loadavg[2]
      }
    }
    metrics.each do |parent, children|
      children.each do |child, value|
        output [<% unless node["system"]["Business"] != nil %>"Zmcc", <% else %>"<%= node["system"]["Business"] %>",<% end %>config[:scheme], dname, parent, child].join("."), value, timestamp
      end
    end
    ok
  end
end

